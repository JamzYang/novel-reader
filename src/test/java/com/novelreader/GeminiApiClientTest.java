package com.novelreader;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;
/**
 * Gemini API客户端的单元测试
 * 注意：这个测试类使用了Mockito进行模拟，需要添加Mockito依赖
 */
@ExtendWith(MockitoExtension.class)
public class GeminiApiClientTest {
    
    private GeminiApiClient apiClient;
    
    @Mock
    private RateLimiter mockRateLimiter;
    
    private final String testApiKey = "AIzaSyB8-fJRn3WYRpoesMhogiZ1Gz2oxdB0al0";
    private final String testModelName = "gemini-2.0-flash";
    private final String testPrompt = "请你阅读并逐步分析《牧神记》的每一章节,输出结果格式是markdown,不要输出任何无关内容。在分析中，请重点关注以下几个方面，并尽可能提供详细的描写和具体的情节：\r\n" + //
                "\r\n" + //
                "男主角的经历：\r\n" + //
                "\r\n" + //
                "男主角在本章节中的冒险旅程、日常生活，以及遇到的具体事件。\r\n" + //
                "\r\n" + //
                "描述男主角在这些章节中的成长，体现在性格、技能、心境等方面的变化。\r\n" + //
                "\r\n" + //
                "男主角在这些章节中是否有重要的转折点或关键事件？如果有，请详细描述事件的内容和影响。\r\n" + //
                "\r\n" + //
                "世界观与设定：\r\n" + //
                "\r\n" + //
                "在本章节中，小说世界观有什么体现？\r\n" + //
                "\r\n" + //
                "详细解释本章节涉及的地理环境、设定、特殊规则和力量原理\r\n" + //
                "\r\n" + //
                "人物关系：\r\n" + //
                "\r\n" + //
                "列出并详细描述与男主角相关的关键人物在本章节中的表现，他们之间的互动、对话，以及对主角的影响。\r\n" + //
                "他们的背景、性格，以及与主角的关系。\r\n" + //
                "\r\n" + //
                "虚构历史：\r\n" + //
                "\r\n" + //
                "如果本章节提到重要的历史事件、传说、神话，请详细说明。\r\n" + //
                "这些历史事件和传说对当前世界和男主角产生了什么影响？\r\n" + //
                "其他重要细节：\r\n" + //
                "\r\n" + //
                "除了上述四点，请关注章节中任何重要的细节，包括伏笔、线索、暗示等。\r\n" + //
                "\r\n" + //
                "总结每章的关键内容，并分析章节之间的关联性。\r\n" + //
                "\r\n" + //
                "请注意：\r\n" + //
                "\r\n" + //
                "避免过于简略，重点突出情节的细节，尽可能用具体的例子和描述来支撑你的分析。\r\n" + //
                "\r\n" + //
                "对于战斗场景，可以简要概括，但重点要放在战斗的结果、对剧情的影响，以及战斗中体现的人物关系和设定。\r\n" + //
                "\r\n" + //
                "对伏笔、线索等进行提示，并分析其可能的影响。";
    private final String testContent = "第1章 天黑别出门\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "　　天黑，别出门。\r\n" + //
                "\r\n" + //
                "　　这句话在残老村流传了很多年，具体是从什么时候传下来的，已经无从考证。不过这句话却是真理，无需怀疑。\r\n" + //
                "\r\n" + //
                "　　残老村的司婆婆看到夕阳一点点藏在山后，心里又紧张起来。随着夕阳落下，最后一缕阳光消失，天地间突然一下子寂静无比，没有任何声音。只见黑暗从西方缓缓的淹没过来，沿途吞噬山川河流道路树木，然后来到残老村，将残老村淹没。\r\n" + //
                "\r\n" + //
                "　　残老村的四个角竖着四个古老石像，石像斑驳，年代久远，即便是司婆婆也不知道这石像是何人雕琢，何时竖在这里。\r\n" + //
                "\r\n" + //
                "　　黑暗降临，四个石像在黑暗中散发出幽幽的光芒，石像依旧亮着，让司婆婆和村里的老者都松了口气。\r\n" + //
                "\r\n" + //
                "　　村外的黑暗越发浓郁，但有了石像的光，残老村便还算是安全的。\r\n" + //
                "\r\n" + //
                "　　突然，司婆婆耳朵动了动，呆了呆，失声道：“你们听，外面有个孩子的哭声！”\r\n" + //
                "\r\n" + //
                "　　旁边的马老摇头道：“不可能，你听错了……咦，真有婴儿的哭声！”\r\n" + //
                "\r\n" + //
                "　　村外的黑暗中传来婴儿的哭声，村里其他老人除了耳聋的都听到了这个哭声，老人们面面相觑，残老村偏僻荒凉，怎么会有婴儿出现在附近？\r\n" + //
                "\r\n" + //
                "　　“我去看看！”\r\n" + //
                "\r\n" + //
                "　　司婆婆激动起来，踮着小脚跑到村子的一个石像边，马老连忙过去：“司老太婆，你疯了？天黑了，出了村就是死！”\r\n" + //
                "\r\n" + //
                "　　“背着这个石像出村，黑暗里的东西怕石像，我一会半会死不了！”\r\n" + //
                "\r\n" + //
                "　　司婆婆弯腰，想要将石像背起，不过她是个驼背，背不起来。马老摇了摇头：“还是我来吧。我背着石像陪你去！”\r\n" + //
                "\r\n" + //
                "　　一旁又有一个老者一瘸一拐的走过来，道：“马爷，你只有一条胳膊，背石像撑不了多久，我两手齐全，还是我来背。”\r\n" + //
                "\r\n" + //
                "　　马老瞪他一眼：“死瘸子，你断了条腿，能走吗？我虽然只有一条胳膊，但这条胳膊力气大得很！”\r\n" + //
                "\r\n" + //
                "　　他独臂将石像抱起，稳了稳步子，石像难以想象的沉重：“司老太婆，咱们走！”\r\n" + //
                "\r\n" + //
                "　　“别叫我死老太婆！瘸子，哑巴，你们大家都要当心些，村里少了一个石像，千万不要被黑暗里的东西摸进来！”\r\n" + //
                "\r\n" + //
                "　　……\r\n" + //
                "\r\n" + //
                "　　马老和司婆婆走出残老村，黑暗中不知有什么古怪的东西围绕两人游走，但被石像的光芒一照，便吱吱怪叫退回黑暗之中。\r\n" + //
                "\r\n" + //
                "　　两人循着那哭声前进，走出百十步，来到一条大江边，那婴儿的哭声就是从江边传来。石像散发出幽幽的光芒，照不太远，两人细细捕捉声音方位，沿着这条江向上游走去，走出几十步，哭声就在附近，马老独臂已经很难支撑。司婆婆眼睛一亮，看到一丁点荧光，那是一个篮子停在江岸边，荧光从篮子里传来，哭声也是从篮子里传来。\r\n" + //
                "\r\n" + //
                "　　“真有一个孩子！”\r\n" + //
                "\r\n" + //
                "　　司婆婆上前，提起篮子，却微微一怔，没能提起来，那篮子下面是一条被江水泡得发白的手臂，正是这条手臂将篮子和篮子里的孩子托起，一直托到岸边。\r\n" + //
                "\r\n" + //
                "　　“放心吧，孩子安全了。”司婆婆对水下的那个女子低声说。\r\n" + //
                "\r\n" + //
                "　　那具女尸似乎听到了她的话，手掌松开，被江水冲走，消失在黑暗中。\r\n" + //
                "\r\n" + //
                "　　司婆婆提起篮子，篮子里是一个襁褓中的婴儿，襁褓上面放着一面玉佩，玉佩散发出荧光。这枚玉佩的光芒与石像的光芒很相似，但是却要微弱很多，正是玉佩保护着篮子里的孩子不受黑暗中的东西的侵害。\r\n" + //
                "\r\n" + //
                "　　只是玉佩的光芒很弱，只能保护得了孩子，却保护不了那个女人。\r\n" + //
                "\r\n" + //
                "　　“是个男孩。”\r\n" + //
                "\r\n" + //
                "　　回到残老村，村子里的村民都围了上来，都是些老弱病残。司婆婆掀开襁褓看了一眼，咧嘴笑了，残牙零落：“我们残老村，终于有一个健全的人了！”\r\n" + //
                "\r\n" + //
                "　　只有一条腿的瘸子吃惊道：“司老太婆，你打算养着他？我们连自己都很难养活！我觉得还是送出去……”\r\n" + //
                "\r\n" + //
                "　　司婆婆大怒：“老娘凭本事捡到的小孩，为什么要送人？”\r\n" + //
                "\r\n" + //
                "　　一众村民唯唯诺诺，不敢反驳她，村长坐着担架过来，他比其他人都要凄惨一些，其他人好歹也有手脚，只是比正常人少，而他则是无手无脚。不过大家对他都很是敬重，即便是凶神恶煞的司婆婆也是不敢放肆。\r\n" + //
                "\r\n" + //
                "　　“既然要养他，那么应该给他取个名字吧？”\r\n" + //
                "\r\n" + //
                "　　村长道：“老太婆，你看篮子里还有其他什么东西吗？”\r\n" + //
                "\r\n" + //
                "　　司婆婆翻了翻，摇头道：“只有这块玉佩，没有其他纸条什么的。玉佩上有字，是个秦字。这块玉佩没有杂质，里面还有奇怪的力量，不是凡品，应该是出自大户人家吧？”\r\n" + //
                "\r\n" + //
                "　　“他是叫秦，还是姓秦？”\r\n" + //
                "\r\n" + //
                "　　村长思索，道：“就让他姓秦吧，名字就叫做牧，秦牧。长大了，便叫他去放牧，好歹能够过活。”\r\n" + //
                "\r\n" + //
                "　　“秦牧。”司婆婆看着襁褓中的婴孩，那婴孩也不怕她，竟然咿咿呀呀的笑了。\r\n" + //
                "\r\n" + //
                "　　……\r\n" + //
                "\r\n" + //
                "　　江边，笛声传来，牧童坐在一头母牛背上吹笛，笛声清脆悠扬。这牧童十一二岁年纪，长得眉清目秀，唇红齿白，衣衫半敞，胸前挂着一枚玉佩。\r\n" + //
                "\r\n" + //
                "　　这少年正是十一年前司婆婆从江边捡来的婴儿，这些年来村里的老人含辛茹苦将这孩子养大，司婆婆不知从哪儿弄来一头母牛，让婴儿时的秦牧每天喝牛奶，熬过了容易早夭的时期。\r\n" + //
                "\r\n" + //
                "　　残老村的村民虽然都凶神恶煞，但对他都很好，司婆婆是个裁缝，平日里秦牧随着司婆婆学裁衣，跟着药师学采药炼药，跟着瘸子爷爷学腿功，跟着瞎子爷爷学听音辨位，跟着没有手脚的村长学呼吸吐纳，日子倒也过得很快。\r\n" + //
                "\r\n" + //
                "　　这头母牛是他儿时的奶娘，司婆婆原本打算卖掉，但秦牧不舍，因此放牛的任务便也交给了他。\r\n" + //
                "\r\n" + //
                "　　他经常在江边放牛，青山如黛，碧波白云，很是惬意。\r\n" + //
                "\r\n" + //
                "　　“秦牧，秦牧，救救我！”\r\n" + //
                "\r\n" + //
                "　　突然，他身下的母牛开口说话，秦牧吓了一跳，连忙从牛背上跳下来，只见那头母牛眼中含泪，口吐人言，向他道：“秦牧，你吃我奶长大，我算是你半个娘，你要救我！”\r\n" + //
                "\r\n" + //
                "　　秦牧眨眨眼睛，试探道：“我如何救你？”\r\n" + //
                "\r\n" + //
                "　　那母牛道：“你腰间有镰刀，将我的皮扒下来，便可以救我脱困。”\r\n" + //
                "\r\n" + //
                "　　秦牧迟疑，母牛道：“你忘记哺育之恩了吗？”\r\n" + //
                "\r\n" + //
                "　　秦牧举起镰刀，小心翼翼割破牛皮，说来也怪牛皮被剥开，竟然没有一丝血流出，而且牛皮里面竟然是空的，没有血肉和骨架。\r\n" + //
                "\r\n" + //
                "　　牛皮剥到一半时，从里面滚出一个二三十岁的妇人，两条腿依旧包裹在牛腿中，皮肉与牛皮相连，不过上肢已经从牛皮中脱开。\r\n" + //
                "\r\n" + //
                "　　那女子披头散发，一把抢过已经吓呆了的秦牧手中的镰刀，两三下切开腿脚上的牛皮，看向秦牧，恶向胆边生，镰刀架在秦牧脖子上，冷笑道：“小恶人，因为你我才被变成一头牛，十一年来我只能吃草，还要喂你奶喝！可怜，我变成牛之前刚刚生了孩子，便被那妖妇暗算，将我变成一头牛给你喂奶！今日终于脱困，先杀了你再来血洗这村里的恶人！”\r\n" + //
                "\r\n" + //
                "　　秦牧脑中轰然，不知道这个从牛皮里钻出来的女子在说些什么。\r\n" + //
                "\r\n" + //
                "　　那女子正要一刀砍死他，突然后心一凉，低头看去，一口刀从她胸前穿出。\r\n" + //
                "\r\n" + //
                "　　“牧儿，你药师爷爷让你回去吃药了。”女子尸体倒下，身后站着的是村里的瘸子爷爷，慈眉善目，一脸憨厚，手里拎着一口血淋漓的刀，向秦牧笑道。\r\n" + //
                "\r\n" + //
                "　　“瘸子爷爷……”秦牧身躯发软，看了看地上的那张牛皮和女子尸体，还是没有回过神来。\r\n" + //
                "\r\n" + //
                "　　“回去，回去。”瘸子拍了拍他的肩头，呵呵笑道。\r\n" + //
                "\r\n" + //
                "　　秦牧一脚高一脚低往村里走，回头看去，却见瘸子将那女子的尸体丢进江里。\r\n" + //
                "\r\n" + //
                "　　这一幕给他的冲击实在太大，以至于他都不知道自己是何时回到村子里。\r\n" + //
                "\r\n" + //
                "　　“秦牧！死小子，怎么告诉你的？天黑别出门！”\r\n" + //
                "\r\n" + //
                "　　夜幕降临，残老村四角的石像又自动亮了起来，司婆婆唤住正打算溜出村子去江边查看牛皮的秦牧，将他拖了回来。\r\n" + //
                "\r\n" + //
                "　　“婆婆，为什么天黑不能出门？”秦牧抬头问道。\r\n" + //
                "\r\n" + //
                "　　“天黑的时候，会有一些可怕的东西在黑暗中活动，出去就是死。”\r\n" + //
                "\r\n" + //
                "　　司婆婆郑重道：“村里的石像会保护我们，黑暗里的东西不敢进入村子。”\r\n" + //
                "\r\n" + //
                "　　“其他村子也有这样的石像吗？”秦牧好奇道。\r\n" + //
                "\r\n" + //
                "　　司婆婆点头，面色却有些忧虑，不住的看向村外，低声道：“瘸子应该回来了……真不应该让瘸子出去的，这家伙只有一条腿……”\r\n" + //
                "\r\n" + //
                "　　“婆婆，今天出怪事了……”\r\n" + //
                "\r\n" + //
                "　　秦牧迟疑一下，将牛肚子里钻出个女人的事情说了一遍，司婆婆漫不经心道：“你是说那个女人？瘸子跟我说过了，他处理得很好。早在你四岁断奶的时候我就说过将牛卖了，只是你舍不得，所以才让你喂着。你看，现在出事了吧？我就说吃奶吃到四岁，会对奶牛有感情。”\r\n" + //
                "\r\n" + //
                "　　秦牧红了脸，四岁断奶的确有些太长了，不过好像关键不是在四岁断奶吧？\r\n" + //
                "\r\n" + //
                "　　“婆婆，那个女人被瘸爷爷杀了……”\r\n" + //
                "\r\n" + //
                "　　“杀得好。”\r\n" + //
                "\r\n" + //
                "　　司婆婆笑道：“那是便宜了她。十一年前她就应该死了，如果不是要奶你，她能活到现在？”\r\n" + //
                "\r\n" + //
                "　　秦牧不明所以。\r\n" + //
                "\r\n" + //
                "　　司婆婆瞥他一眼，道：“这女子是距离这儿千里外的镶龙城城主夫人，镶龙城主好色，而她善妒，镶龙城主喜欢在外面拈花惹草，强掠良家女子。而镶龙城主每坏了一个女子的清白，这位城主夫人便会派人将那女子活活打死。我潜入镶龙城，原本打算杀她，见到她刚刚生了一个孩子，孩子才三个月，又想到你还没有奶喝，而她有奶，于是将她变成一头奶牛回来奶你。只是没想到这女子竟然挣脱了封印，能够开口说话，差点就害了你。”\r\n" + //
                "\r\n" + //
                "　　秦牧瞠目结舌，失声道：“婆婆，人怎么能变成牛？”\r\n" + //
                "\r\n" + //
                "　　司婆婆嘿嘿一笑，露出半嘴零落牙齿：“你想学？我教你……瘸子回来了！”\r\n" + //
                "\r\n" + //
                "　　秦牧看去，只见瘸子一手拄着拐杖，一手抓着背上的猎物，正一瘸一拐的走来。黑暗如同潮水飞快的向村子涌来，司婆婆急忙叫道：“死瘸子，快点，快点！”\r\n" + //
                "\r\n" + //
                "　　“急什么？”\r\n" + //
                "\r\n" + //
                "　　瘸子还是不紧不慢的往村子走，在他走入村子的一刹那，浓烈的黑暗正好将村子淹没。他背上的猎物是一头斑斓猛虎，还没有死，尾巴被黑暗扫中，突然猛虎发出一声哀吼，秦牧连忙看去，只见猛虎的尾巴竟然只剩下了一节节骨头，尾巴上的皮毛和血肉全都不见了，好像是被什么东西啃掉的一般。\r\n" + //
                "\r\n" + //
                "　　他好奇的看了看村外的黑暗，那里漆黑一片，什么也看不到。\r\n" + //
                "\r\n" + //
                "　　“黑暗里到底有什么？”他心中纳闷。\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "第2章 四灵血\r\n" + //
                "\r\n" + //
                "\r\n" + //
                "　　司婆婆拉着他兴冲冲的往村里走，笑道：“别看了，快点过来，今天是你的大日子！村长，马爷，都出来！”\r\n" + //
                "\r\n" + //
                "　　村里燃起了篝火，村长又被人用担架抬了出来，沉声道：“四灵都找到了？”\r\n" + //
                "\r\n" + //
                "　　“都找到了。”\r\n" + //
                "\r\n" + //
                "　　独臂的马爷拖来了一条几丈长的大蛇，碧青色，也还活着，泛着腥气，只是被马爷单手捏住七寸，动弹不得。\r\n" + //
                "\r\n" + //
                "　　哑巴铁匠则提来了一头大鸟，那头大鸟比哑巴还要高大一些，但是被绑住了翅膀和双脚。那大鸟挣扎时，羽毛中竟然有火光飞出，噼里啪啦作响，很是吓人。\r\n" + //
                "\r\n" + //
                "　　瞎子则搬来了一只比桌子面还要大的巨龟，这头巨龟不知活了多少年，龟壳都翻起了金黄色。巨龟四肢都缩在壳里，时不时偷偷的探出一只爪子，秦牧看到它的爪子探出壳，爪子下便生出水汽，似乎能够将这头金龟托起，驾着水汽逃之夭夭。\r\n" + //
                "\r\n" + //
                "　　只是金龟被瞎子用鱼钩穿住鼻孔，无法逃走。\r\n" + //
                "\r\n" + //
                "　　“青龙，白虎，朱雀，玄武，这四灵的血虽然无法弄到，不过用青蛟蛇、铁骨虎、雷鸟和金龟代替，也可以炼出一点灵血来，足够用了。”\r\n" + //
                "\r\n" + //
                "　　村长向村里的屠户点了点头，屠户咧嘴笑了笑，双手撑地上前，他是个只剩下上半身的汉子，腰部以下被人砍断，伤口平整。\r\n" + //
                "\r\n" + //
                "　　四口缸放在青蛇老虎雷鸟和金龟前，屠户一刀一只，给这些猛兽放血，过了不久，四个猎物鲜血流尽。\r\n" + //
                "\r\n" + //
                "　　“药师。”村长说。\r\n" + //
                "\r\n" + //
                "　　村里的药师上前，他没有脸，脸上的皮似乎是被人切了下来，一起切下来的还有他的鼻子，以及半张嘴的上唇下唇，是村里最丑陋可怕的人，不过秦牧则觉得药师爷爷是村里对他最和蔼的人。\r\n" + //
                "\r\n" + //
                "　　药师上前，取出四片奇特的红色叶子，每片叶子上都有一颗雪白的虫卵。药师在每个缸里各投一片叶子，便见虫卵破开，蚕虫趴在叶子上喝血。\r\n" + //
                "\r\n" + //
                "　　这些蚕虫见风就长，喝的血越多，身体便越大，很快四口缸里的血都被喝干，每口缸里都剩下一只又肥又大的虫子。\r\n" + //
                "\r\n" + //
                "　　药师抓了把像盐一样的白色晶沫撒在缸里，秦牧看到四条又肥又大的虫子竟然在飞速缩小，不由啧啧称奇。\r\n" + //
                "\r\n" + //
                "　　过了片刻，药师将四条虫子捡了起来，每条虫子都只有巴掌大小。只见他取出四个白瓷杯，抓住一只虫子用力挤了挤，那虫子吱吱叫，嘴里流出一杯琥珀般晶莹剔透的血浆。\r\n" + //
                "\r\n" + //
                "　　药师如法炮制，将其他三只虫子肚子里的血挤出，将四个杯子放在秦牧面前，摇头道：“毕竟不是真正的灵兽，能够提炼出的灵血只有这么点儿。”\r\n" + //
                "\r\n" + //
                "　　“牧儿，人体内藏有七大宝库，灵胎，五曜，六合，七星，天人，生死，神桥，这七大宝库天生就是被封闭的，像是被封闭起来的宝藏，因此被称作七大神藏。”\r\n" + //
                "\r\n" + //
                "　　村长声音带着几分威严，在篝火的映照下，脸庞忽明忽暗，沉声道：“七大神藏处在封闭的状态，需要武者自己打开，阻挡武者开启神藏的障碍便是壁，灵胎壁，五曜壁，六合壁，七星壁，天人壁，生死壁，神桥壁。破开这七壁的过程，称为破壁。”\r\n" + //
                "\r\n" + //
                "　　独臂马爷轻轻抚摸秦牧的头，笑道：“壁破不开，便无法修炼。有的人上天眷顾，一出生灵胎壁便是破的，天生便开启了灵胎神藏，这种体质，被称作灵体，天生神佑，是修炼的苗子。拥有灵体的人，天分要比普通人高出不知凡几，修炼起来事半功倍。灵胎有着四种属性，因此灵体也有四种，青龙灵体，白虎灵体，朱雀灵体，玄武灵体。想要检查是否是灵体，就需要这四灵血。”\r\n" + //
                "\r\n" + //
                "　　药师道：“倘若你是青龙灵体，饮下青龙灵血后，便会激发青龙之气。马爷便是青龙灵体。”\r\n" + //
                "\r\n" + //
                "　　独臂马爷解开衣裳，赤膊站在秦牧面前，转身背对着他，低喝一声。\r\n" + //
                "\r\n" + //
                "　　秦牧立刻看到马爷的背后浮现出一道青气，从尾骨直达后脑，青气渐渐变化，变成一条青龙，鳞须纤毫毕现，一条龙爪延伸到马爷的独臂，还有两条龙爪缠绕在马爷的双腿上。\r\n" + //
                "\r\n" + //
                "　　“这就是青龙灵体。”\r\n" + //
                "\r\n" + //
                "　　独臂马爷穿上衣衫：“司老太婆是白虎灵体。”\r\n" + //
                "\r\n" + //
                "　　司婆婆白他一眼，道：“老娘可不脱衣裳便宜你们这些老鬼。我用气显形给秦牧看看。”\r\n" + //
                "\r\n" + //
                "　　她身躯微震，身后隐约传来一声虎啸，一头丈二吊睛白虎若隐若现出现在她身后。\r\n" + //
                "\r\n" + //
                "　　“村子里的所有人，都是灵体。当年我们也曾荣耀过，但现在只不过都是一群又老又废的老头子老太婆。”\r\n" + //
                "\r\n" + //
                "　　司婆婆笑道：“我们这些残老废没什么能够给你的，这四杯四灵血便是激发灵体的材料，倘若你是白虎灵体，喝下白虎灵血便会激发你灵胎中的白虎之气，若是朱雀灵体，朱雀灵血便可以让你灵胎中的朱雀之气活跃起来。玄武灵体也是如此。”\r\n" + //
                "\r\n" + //
                "　　“喝吧。”\r\n" + //
                "\r\n" + //
                "　　村长、司婆婆等人齐刷刷的向秦牧看来，露出期待之色。\r\n" + //
                "\r\n" + //
                "　　秦牧心里直打鼓，虽然他跟随药师学习采药炼药的时候也被灌了不知多少奇怪的东西，但都没有这次奇怪。\r\n" + //
                "\r\n" + //
                "　　他端起一个白瓷杯，里面的灵血火烫，是一杯朱雀灵血，秦牧一饮而尽，只觉一道火线入喉，直达四肢百骸，让他恍惚间觉得自己体内似乎燃起熊熊烈火，烧得自己的血都仿佛要沸腾了一般。\r\n" + //
                "\r\n" + //
                "　　过了片刻，这种燃烧感散去。\r\n" + //
                "\r\n" + //
                "　　“哑巴，他是朱雀灵体吗？”村长问道。\r\n" + //
                "\r\n" + //
                "　　哑巴铁匠摇了摇头。\r\n" + //
                "\r\n" + //
                "　　村长道：“秦牧，继续。”\r\n" + //
                "\r\n" + //
                "　　秦牧印下第二个白瓷杯，里面是白虎灵血，喝到口中仿佛是在喝混着铁渣的铜汁铁水，涩，刺痛，入体之后全身都是刺痛感。不久，刺痛感消失。\r\n" + //
                "\r\n" + //
                "　　“不是白虎灵体。”司婆婆摇了摇头，有些失望。\r\n" + //
                "\r\n" + //
                "　　“秦牧，第三杯。”村长沉声道。\r\n" + //
                "\r\n" + //
                "　　秦牧喝下第三杯大青蛇提炼出的青龙灵血，这杯灵血让他只觉肌肉又鼓又胀，血液又鼓又胀，五脏六腑被挤得难受，不过肿胀感也很快消失。\r\n" + //
                "\r\n" + //
                "　　马爷露出失望之色，摇头道：“不是青龙灵体。”\r\n" + //
                "\r\n" + //
                "　　“那么一定是玄武灵体。”药师难得的露出一丝笑容，面孔显得更加狰狞。\r\n" + //
                "\r\n" + //
                "　　秦牧饮下最后一杯玄武灵血，玄武灵血让他身子轻盈起来，仿佛浸泡到江水之中，然而这种感觉也很快消失。\r\n" + //
                "\r\n" + //
                "　　“他也不是玄武灵体。”药师摇头。\r\n" + //
                "\r\n" + //
                "　　篝火旁的村民们都沉默下来，屠户道：“这么说来，他就是普普通通的普通人。”\r\n" + //
                "\r\n" + //
                "　　司婆婆突然落泪，哽咽道：“我们都老了，废了，我们如果死了，他活不下去的，这里这么危险，他一天都活不下去……”\r\n" + //
                "\r\n" + //
                "　　秦牧拉着她的手，低声道：“婆婆，别哭，婆婆和爷爷都是好人，都不会死……”\r\n" + //
                "\r\n" + //
                "　　“好人？嘿嘿……”\r\n" + //
                "\r\n" + //
                "　　马爷自嘲一笑，道：“我们这些废人被逼到大墟中，苟延残喘活到现在，大墟太危险，没有我们，牧儿的确很难活下去。我们应该把他送出大墟，外面安全很多……”\r\n" + //
                "\r\n" + //
                "　　屠户冷冰冰道：“送他出去，我们会被仇家发现，都会死，他也会被我们连累，也会死。”\r\n" + //
                "\r\n" + //
                "　　残老村再次沉默下来。突然村长道：“好。”\r\n" + //
                "\r\n" + //
                "　　司婆婆纳闷：“什么好？”\r\n" + //
                "\r\n" + //
                "　　村长露出笑容：“我说他的体质好，是个好苗子。”\r\n" + //
                "\r\n" + //
                "　　屠户、药师等人都是一怔，不明其意，村长笑道：“我觉得牧儿应该是另一种体质，结合四大体质之长的霸体！”\r\n" + //
                "\r\n" + //
                "　　“霸体？”司婆婆等人露出疑惑之色，他们都是见多识广之辈，但是也没有听说过霸体这个名字。\r\n" + //
                "\r\n" + //
                "　　“对，是霸体。”\r\n" + //
                "\r\n" + //
                "　　村长笑道：“普通的灵血很难激发霸体，需要集齐真正的四大灵兽之血，才能让霸体显现出来。大墟中没有四大灵兽，但是灵兽的后代却并不难寻，你们继续捕捉猛虎大蛇，炼出灵血，喝得多了，自然能够将他的霸体激发出来。”\r\n" + //
                "\r\n" + //
                "　　村长很有威信，村里缺胳膊少腿的老头老太太听了都很是开心，司婆婆笑道：“明天我也陪死瘸子去捉老虎！牧儿，你也早点睡，明天还要喝灵血！”\r\n" + //
                "\r\n" + //
                "　　众人散去，药师和哑巴铁匠将村长送回房间，哑巴离开，药师却没有走，低声道：“从来没有过霸体。”\r\n" + //
                "\r\n" + //
                "　　村长点头：“是我信口说的。我不这么说，村里的人都很难活下去。”\r\n" + //
                "\r\n" + //
                "　　药师怔了怔。残老村的村民各有来历，但都被逼得不得不进入大墟来到残老村，苟延残喘，他们本来怨天怨地怨苍生，怨气太重，能够活到现在，不能不说秦牧也有功劳。\r\n" + //
                "\r\n" + //
                "　　正是这个手足健全的小娃娃的到来，冲散了众人心中的怨气，大家抚养秦牧长大，都将这个小男孩当成自己最亲的人，秦牧维系着残老村的村民脆弱的心灵。\r\n" + //
                "\r\n" + //
                "　　倘若村民们知道秦牧只是最普通的体质，无法独自在大墟中存活，只怕这些家伙都会失控，不知道会做出什么事来。\r\n" + //
                "\r\n" + //
                "　　药师面无表情道：“但是你瞒不了一辈子，我们迟早都会老死，只剩下秦牧。”\r\n" + //
                "\r\n" + //
                "　　“所以你不要告诉他从来没有过霸体，永远也不要告诉他。”\r\n" + //
                "\r\n" + //
                "　　村长沉声道：“让他相信，他就是独一无二的霸体！”\r\n" + //
                "\r\n" + //
                "　　药师怔了怔，仔仔细细看了看他的脸庞。村长的脸庞在昏暗的油灯下显得格外有魅力，笑道：“我想看看，一个普通人在无与伦比的信念下会不会超凡脱俗，做出我们这些灵体也做不出的事情来！说不定将来，他真的能够走出一条凡体即霸体的道路来！”\r\n" + //
                "\r\n" + //
                "　　药师呆了呆：“凡体即霸体？”\r\n" + //
                "\r\n" + //
                "　　村长重重点头：“只要有信念，凡体即霸体！”";
    
    @BeforeEach
    public void setUp() {
        apiClient = new GeminiApiClient(testApiKey, mockRateLimiter);
    }
    
    /**
     * 注意：由于实际API调用需要网络连接和真实的API密钥，
     * 这个测试方法被标记为disabled。在实际环境中，
     * 你可能需要使用模拟HTTP客户端来测试API调用。
     */
    @Test
    public void testAnalyzeChapterGroup_MockedImplementation() throws InterruptedException {
        // 创建测试请求
        ApiRequest request = new ApiRequest(testModelName, testPrompt, testContent);
        
        // 由于我们不能实际调用API，这里我们只测试RateLimiter的使用
        // 实际项目中，你可能需要模拟HttpClient来测试完整的API调用流程
        
        // 执行API调用（注意：这会尝试实际调用API，但会因为无效的API密钥而失败）
        ApiResponse response = apiClient.analyzeChapterGroup(request);
        System.out.println(response.toString());
        // 验证RateLimiter被正确使用
        verify(mockRateLimiter, times(1)).acquire();
        verify(mockRateLimiter, times(1)).release();
        
        // 由于我们使用了测试API密钥，预期API调用会失败
        assertTrue(response.isSuccess(), "使用测试API密钥应该导致API调用失败");
        assertNotNull(response.responseBody(), "应该有错误消息");
    }
    
    /**
     * 测试API请求对象的创建和属性
     */
    @Test
    public void testApiRequest() {
        ApiRequest request = new ApiRequest(testModelName, testPrompt, testContent);
        
        assertEquals(testModelName, request.getModelName(), "模型名称不匹配");
        assertEquals(testPrompt, request.getPrompt(), "提示不匹配");
        assertEquals(testContent, request.getChapterGroupContent(), "内容不匹配");
        
        // 测试setter
        String newModelName = "gemini-pro-vision";
        request.setModelName(newModelName);
        assertEquals(newModelName, request.getModelName(), "更新后的模型名称不匹配");
    }
    
    /**
     * 测试API响应对象的创建和属性
     */
    @Test
    public void testApiResponse() {
        String successBody = "成功响应";
        ApiResponse successResponse = ApiResponse.success(successBody);
        
        assertTrue(successResponse.isSuccess(), "成功响应的success标志应为true");
        assertEquals(successBody, successResponse.responseBody(), "响应体不匹配");
        assertNull(successResponse.errorMessage(), "成功响应不应有错误消息");
        
        String errorMessage = "错误消息";
        ApiResponse failureResponse = ApiResponse.failure(errorMessage);
        
        assertFalse(failureResponse.isSuccess(), "失败响应的success标志应为false");
        assertNull(failureResponse.responseBody(), "失败响应不应有响应体");
        assertEquals(errorMessage, failureResponse.errorMessage(), "错误消息不匹配");
    }
}
